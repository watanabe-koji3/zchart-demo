import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import matplotlib.pyplot as plt
import matplotlib.patches as patches
import matplotlib_fontja  # æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œãƒ©ã‚¤ãƒ–ãƒ©ãƒª(Python 3.12å¯¾å¿œç‰ˆ)

# -------------------------------------------------------
# 0. ã‚³ãƒ³ã‚»ãƒ—ãƒˆå›³è§£ ä½œæˆãƒ­ã‚¸ãƒƒã‚¯
# -------------------------------------------------------
def create_concept_diagram():
    """
    Zãƒãƒ£ãƒ¼ãƒˆã®ä»•çµ„ã¿ï¼ˆç§»å‹•å¹´è¨ˆã®è¨ˆç®—æ–¹æ³•ï¼‰ã‚’è§£èª¬ã™ã‚‹æ¦‚å¿µå›³ã‚’ä½œæˆã™ã‚‹ã€‚
    
    [æç”»ãƒ­ã‚¸ãƒƒã‚¯]
    1. ç§»å‹•å¹´è¨ˆã®å®šç¾©ï¼šã€Œå½“æœˆã‚’å«ã‚€éå»1å¹´é–“ã®åˆè¨ˆã€
    2. è¦–è¦šè¡¨ç¾ï¼š12ãƒ¶æœˆåˆ†ã®åŒºé–“åˆè¨ˆï¼ˆÃ·12ï¼‰ã‹ã‚‰ã€å½“æœˆã®ãƒ—ãƒ­ãƒƒãƒˆç‚¹ï¼ˆâ—ï¼‰ã¸çŸ¢å°ã‚’çµã¶
    """
    fig, ax = plt.subplots(figsize=(10, 6))
    
    # --- 1. è»¸ã®è¨­å®š ---
    start_year = 2025
    current_line_x = 12 

    ax.set_xlim(-1, 25)
    ax.set_ylim(0, 8) 
    ax.axis('off')

    # ãƒ¡ã‚¤ãƒ³ã®æ¨ªç·š
    ax.plot([-0.5, 24.5], [7, 7], color='black', linewidth=1)

    # ç›®ç››ã‚Šã¨æœˆãƒ©ãƒ™ãƒ«æç”»é–¢æ•°
    def draw_ticks(start_idx, end_idx, year_label_x, year_label_text):
        ax.text(year_label_x, 7.6, year_label_text, fontsize=12, fontweight='bold', color='gray' if start_idx < 12 else 'black')
        
        for i in range(start_idx, end_idx):
            month_val = (4 + i - 1) % 12 + 1
            color = 'gray' if i < 12 else 'black'
            ax.plot([i, i], [7, 6.8], color=color, linewidth=1)
            ax.text(i, 6.5, str(month_val), ha='center', fontsize=10, color=color)

    # 2025å¹´åº¦ (0~11)
    draw_ticks(0, 12, 0, f"{start_year}å¹´")
    # 2026å¹´åº¦ (12~24)
    draw_ticks(12, 24, 12.5, f"{start_year + 1}å¹´")

    # --- 2. ç¾åœ¨åœ°ãƒ©ã‚¤ãƒ³ ---
    ax.axvline(x=current_line_x, ymin=0.05, ymax=0.95, color='black', linestyle='-', linewidth=2.5, alpha=0.8)
    
    # ç¾åœ¨åœ°ãƒ©ãƒ™ãƒ«
    bbox_props = dict(boxstyle="round,pad=0.4", fc="white", ec="black", lw=1)
    ax.text(current_line_x, 8.2, "ç¾åœ¨åœ°\n(2026å¹´4æœˆ)", ha='center', va='center', fontsize=11, fontweight='bold', bbox=bbox_props)


    # --- 3. ãƒãƒ¼æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
    def draw_bar_and_dot(target_index, y_pos):
        """
        target_index: ç§»å‹•å¹´è¨ˆã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹æœˆï¼ˆâ—å°ã®ä½ç½®ï¼‰
        é›†è¨ˆæœŸé–“: target_index(å½“æœˆ)ã‚’å«ã‚€ç›´è¿‘12ãƒ¶æœˆ
        """
        # ãƒ‡ãƒ¼ã‚¿åŒºé–“ã®é–‹å§‹ã¨çµ‚äº†
        # æœˆã®ãƒ—ãƒ­ãƒƒãƒˆç‚¹ã¯æ•´æ•°ä½ç½®(i)ã«ã‚ã‚‹ãŸã‚ã€æœŸé–“ã¨ã—ã¦ã®ã€Œ1ãƒ¶æœˆã€ã¯ [i-0.5, i+0.5] ã¨è€ƒãˆã‚‹
        # å½“æœˆ(target)ã‚’å«ã‚€ç›´è¿‘12ãƒ¶æœˆ = [target-11.5, target+0.5]
        start_x = target_index - 11.5
        width = 12
        
        is_future = (target_index > 12)
        
        bar_color = '#E0F7FA' if is_future else '#EEEEEE'
        edge_color = '#006064' if is_future else '#616161'
        dot_color = 'red' if is_future else 'gray'
        
        # ãƒãƒ¼æœ¬ä½“
        rect = patches.Rectangle((start_x, y_pos), width, 0.6, linewidth=1, edgecolor=edge_color, facecolor=bar_color)
        ax.add_patch(rect)
        
        # "Ã·12" ãƒ†ã‚­ã‚¹ãƒˆ
        # ãƒãƒ¼ã®å³ç«¯ (start_x + width) ã®å°‘ã—æ¨ªã«é…ç½®
        text_x = start_x + width
        text_y = y_pos + 0.3
        ax.text(text_x + 0.2, text_y, "Ã·12", ha='left', va='center', fontsize=9, color='gray')
        
        # æ–œã‚ã®ç‚¹ç·šçŸ¢å°
        # èµ·ç‚¹ (xytext): "Ã·12"ã®æ–‡å­—ä»˜è¿‘
        # çµ‚ç‚¹ (xy): ç›®ç››ã‚Šä¸Šã®â—å°
        ax.annotate('', 
                    xy=(target_index, 7.0),            # çŸ¢å°ã®å…ˆç«¯ï¼ˆâ—å°ï¼‰
                    xytext=(text_x, text_y + 0.3),     # çŸ¢å°ã®å‡ºç™ºç‚¹
                    arrowprops=dict(arrowstyle='->', color=edge_color, linestyle=':', linewidth=1.5, shrinkA=0, shrinkB=5))
        
        # â—å°
        ax.plot(target_index, 7.0, marker='o', color=dot_color, markersize=6, zorder=5)

    # --- 4. 4æœ¬ã®ãƒãƒ¼ã‚’æç”» ---
    draw_bar_and_dot(12, 5.5) # 2026/4
    draw_bar_and_dot(13, 4.0) # 2026/5
    draw_bar_and_dot(22, 2.0) # 2027/2
    draw_bar_and_dot(23, 0.5) # 2027/3

    plt.tight_layout()
    return fig

# -------------------------------------------------------
# 1. ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (ãƒ¡ãƒ¢ãƒªä¸Šã§DFã‚’ä½œæˆ)
# -------------------------------------------------------
def generate_data(base_sales, annual_growth_amount, seasonality_pattern):
    """
    ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¨­å®šå€¤ã«åŸºã¥ã„ã¦ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹
    
    Args:
        base_sales (int): ãƒ™ãƒ¼ã‚¹å£²ä¸Š
        annual_growth_amount (int): å½“æœŸ1å¹´é–“ã®æˆé•·é¡ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ - ãƒ™ãƒ¼ã‚¹ï¼‰
        seasonality_pattern (list or array): 12ãƒ¶æœˆåˆ†ã®å­£ç¯€æŒ‡æ•° (1.0ãŒåŸºæº–)
    """
    # 2å¹´åˆ†(24ãƒ¶æœˆ)ã®æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿
    # å‰æœŸ: 2025-04 ~ 2026-03 (è¨ˆç®—ç”¨)
    # å½“æœŸ: 2026-04 ~ 2027-03 (è¡¨ç¤ºç”¨)
    # Pandas 2.2.0ä»¥é™å‘ã‘ã®æ¨å¥¨è¡¨è¨˜ 'ME' ã‚’ä½¿ç”¨
    dates = pd.date_range(start='2025-04-01', periods=24, freq='ME')
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¯ã€Œ1å¹´åˆ†ã€ã®æˆé•·é¡ãªã®ã§ã€
    # 2å¹´åˆ†ï¼ˆ24ãƒ¶æœˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ãŸã‚ã«ã€å‚¾ãã‚’ç¶­æŒã—ãŸã¾ã¾2å€ã®æœŸé–“ã«é©ç”¨ã™ã‚‹ã€‚
    total_growth_2years = annual_growth_amount * 2
    trend = np.linspace(0, total_growth_2years, 24)
    
    # å­£ç¯€æŒ‡æ•° (12ãƒ¶æœˆåˆ†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’2å›ç¹°ã‚Šè¿”ã—ã¦24ãƒ¶æœˆåˆ†ã«ã™ã‚‹)
    pattern_arr = np.array(seasonality_pattern)
    seasonality = np.tile(pattern_arr, 2)  # [1æœˆ, 2æœˆ...] * 2
    
    # å£²ä¸Šè¨ˆç®—: (ãƒ™ãƒ¼ã‚¹ + ãƒˆãƒ¬ãƒ³ãƒ‰) * å­£ç¯€æŒ‡æ•°
    sales = (base_sales + trend) * seasonality
    
    df = pd.DataFrame({
        'å¹´æœˆ': dates,
        'å£²ä¸Šé«˜': sales.astype(int)
    })
    return df

# -------------------------------------------------------
# 2. Plotly (å‹•çš„ã‚°ãƒ©ãƒ•) ä½œæˆãƒ­ã‚¸ãƒƒã‚¯
# -------------------------------------------------------
def create_plotly_z_chart(df):
    # ãƒ‡ãƒ¼ã‚¿åŠ å·¥
    # rolling(12)ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œå½“è¡Œã‚’å«ã‚€ç›´è¿‘12è¡Œã€ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã€Zãƒãƒ£ãƒ¼ãƒˆã®å®šç¾©ã¨ä¸€è‡´ã™ã‚‹
    df['ç§»å‹•å¹´è¨ˆ'] = df['å£²ä¸Šé«˜'].rolling(window=12).sum()
    
    # å¾ŒåŠ12ãƒ¶æœˆï¼ˆå½“æœŸåˆ†ï¼‰ã®ã¿ã‚’åˆ‡ã‚Šå‡ºã™
    current_fy = df.iloc[12:].copy().reset_index(drop=True)
    current_fy['å£²ä¸Šç´¯è¨ˆ'] = current_fy['å£²ä¸Šé«˜'].cumsum()
    current_fy['å¹´æœˆãƒ©ãƒ™ãƒ«'] = current_fy['å¹´æœˆ'].dt.strftime('%Yå¹´%mæœˆ')

    # Plotlyã‚°ãƒ©ãƒ•æ§‹ç¯‰
    fig = go.Figure()

    # (A) ç§»å‹•å¹´è¨ˆ (èµ¤/ã‚ªãƒ¬ãƒ³ã‚¸)
    fig.add_trace(go.Scatter(
        x=current_fy['å¹´æœˆãƒ©ãƒ™ãƒ«'], y=current_fy['ç§»å‹•å¹´è¨ˆ'],
        mode='lines+markers', name='ç§»å‹•å¹´è¨ˆ (æ¥­ç¸¾ãƒˆãƒ¬ãƒ³ãƒ‰)',
        line=dict(color='#FF5733', width=4),
        hovertemplate='ç§»å‹•å¹´è¨ˆ: %{y:,}åƒå††'
    ))

    # (B) å£²ä¸Šç´¯è¨ˆ (ç·‘)
    fig.add_trace(go.Scatter(
        x=current_fy['å¹´æœˆãƒ©ãƒ™ãƒ«'], y=current_fy['å£²ä¸Šç´¯è¨ˆ'],
        mode='lines+markers', name='å£²ä¸Šç´¯è¨ˆ (é€²æ—)',
        line=dict(color='#33FF57', width=3, dash='dash'),
        hovertemplate='å£²ä¸Šç´¯è¨ˆ: %{y:,}åƒå††'
    ))

    # (C) æœˆæ¬¡å£²ä¸Š (é’)
    fig.add_trace(go.Scatter(
        x=current_fy['å¹´æœˆãƒ©ãƒ™ãƒ«'], y=current_fy['å£²ä¸Šé«˜'],
        mode='lines+markers', name='æœˆæ¬¡å£²ä¸Š (å­£ç¯€å¤‰å‹•)',
        line=dict(color='#3357FF', width=2, dash='dot'),
        hovertemplate='æœˆæ¬¡å£²ä¸Š: %{y:,}åƒå††'
    ))

    fig.update_layout(
        title='å£²ä¸Šé«˜ Zãƒãƒ£ãƒ¼ãƒˆåˆ†æ (Plotlyç‰ˆ)',
        xaxis_title='æœˆåº¦',
        yaxis_title='é‡‘é¡ (åƒå††)',
        yaxis=dict(tickformat=","),
        hovermode="x unified",
        legend=dict(orientation="h", y=1.1),
        height=500
    )
    
    return fig, current_fy

# -------------------------------------------------------
# 3. Matplotlib (é™æ­¢ç”»ã‚°ãƒ©ãƒ•) ä½œæˆãƒ­ã‚¸ãƒƒã‚¯
# -------------------------------------------------------
def create_matplotlib_z_chart(current_fy):
    """
    ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å—ã‘å–ã‚Šã€Matplotlibã®Figureã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
    """
    # å›³ã®å™¨ã‚’ä½œæˆ
    fig, ax = plt.subplots(figsize=(12, 8))
    
    months = current_fy['å¹´æœˆ'].dt.strftime('%mæœˆ')
    x = np.arange(len(months)) 

    # (A) ç§»å‹•å¹´è¨ˆ
    line_a, = ax.plot(months, current_fy['ç§»å‹•å¹´è¨ˆ'], label='ç§»å‹•å¹´è¨ˆ', 
            color='#FF5733', linewidth=2, marker='o')
    
    # (B) å£²ä¸Šç´¯è¨ˆ
    line_b, = ax.plot(months, current_fy['å£²ä¸Šç´¯è¨ˆ'], label='å£²ä¸Šç´¯è¨ˆ', 
            color='#33FF57', linewidth=2, marker='o', linestyle='--')
    
    # (C) æœˆæ¬¡å£²ä¸Š
    line_c, = ax.plot(months, current_fy['å£²ä¸Šé«˜'], label='æœˆæ¬¡å£²ä¸Š', 
            color='#3357FF', linewidth=2, marker='o', linestyle=':')

    # --- æ•°å€¤ãƒ©ãƒ™ãƒ«ã®è¿½åŠ  ---
    label_params = dict(fontsize=8, textcoords="offset points", ha='center')

    # (A) ç§»å‹•å¹´è¨ˆ
    for i, y in enumerate(current_fy['ç§»å‹•å¹´è¨ˆ']):
        ax.annotate(f"{int(y):,}", xy=(i, y), xytext=(0, 10), va='bottom', 
                    color=line_a.get_color(), **label_params)
        
    # (B) å£²ä¸Šç´¯è¨ˆ
    for i, y in enumerate(current_fy['å£²ä¸Šç´¯è¨ˆ']):
        ax.annotate(f"{int(y):,}", xy=(i, y), xytext=(-15, 10), va='bottom', ha='right',
                    color=line_b.get_color(), fontsize=8, textcoords="offset points")

    # (C) æœˆæ¬¡å£²ä¸Š
    for i, y in enumerate(current_fy['å£²ä¸Šé«˜']):
        ax.annotate(f"{int(y):,}", xy=(i, y), xytext=(0, -10), va='top',
                    color=line_c.get_color(), **label_params)

    # è£…é£¾
    ax.set_title('å£²ä¸Šé«˜ Zãƒãƒ£ãƒ¼ãƒˆ (Matplotlibç‰ˆ - å°åˆ·ç”¨å…¨æ•°å€¤å…¥ã‚Š)', fontsize=16)
    ax.set_ylabel('é‡‘é¡ (åƒå††)', fontsize=12)
    ax.set_xlabel('æœˆåº¦', fontsize=12)
    ax.grid(True, linestyle='--', alpha=0.6)
    ax.legend()
    
    # Yè»¸ã®ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š
    ax.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, loc: "{:,}".format(int(x))))
    
    plt.tight_layout()
    return fig

# -------------------------------------------------------
# 4. Streamlit ãƒ¡ã‚¤ãƒ³ç”»é¢æ§‹æˆ
# -------------------------------------------------------
def main():
    st.set_page_config(page_title="ä¼šè¨ˆå‚è¬€ãƒ‡ãƒ¢", layout="wide")
    
    st.title("ğŸ“Š çµŒå–¶åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (Zãƒãƒ£ãƒ¼ãƒˆ)")
    st.markdown("ç§»å‹•å¹´è¨ˆã‚’æ´»ç”¨ã—ã¦ã€å­£ç¯€å¤‰å‹•ã‚’é™¤ã„ãŸã€ŒçœŸã®æ¥­ç¸¾ãƒˆãƒ¬ãƒ³ãƒ‰ã€ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚")

    # --- è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: åŸºç¤çŸ¥è­˜ ---
    with st.expander("ğŸ”° Zãƒãƒ£ãƒ¼ãƒˆã®è¦‹æ–¹ãƒ»ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰æï¼ˆåˆã‚ã¦ã®æ–¹ã¯ã“ã¡ã‚‰ï¼‰"):
        st.markdown("""
        ### 1. Zãƒãƒ£ãƒ¼ãƒˆã¨ã¯ï¼Ÿ
        å£²ä¸Šã®ã€Œå­£ç¯€ã”ã¨ã®æ³¢ï¼ˆç¹å¿™æœŸãƒ»é–‘æ•£æœŸï¼‰ã€ã‚’å–ã‚Šé™¤ãã€**ä¼šç¤¾ã®æœ¬å½“ã®å®ŸåŠ›ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰**ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã®ã‚°ãƒ©ãƒ•ã§ã™ã€‚
        3æœ¬ã®ç·šãŒã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ã€ŒZã€ã®å½¢ã‚’æãã“ã¨ã‹ã‚‰ã“ã†å‘¼ã°ã‚Œã¾ã™ã€‚

        * ğŸ”´ **ç§»å‹•å¹´è¨ˆ (èµ¤å®Ÿç·š)**: **æœ€é‡è¦**ã€‚ã€Œéå»1å¹´é–“ã®å£²ä¸Šåˆè¨ˆã€ã®æ¨ç§»ã€‚ã‚¸ã‚°ã‚¶ã‚°ã—ãŸæ³¢ãŒæ¶ˆãˆã€**å³è‚©ä¸ŠãŒã‚Šãªã‚‰æˆé•·ä¸­ã€å³è‚©ä¸‹ãŒã‚Šãªã‚‰è¡°é€€ä¸­**ã¨åˆ¤æ–­ã§ãã¾ã™ã€‚
        * ğŸŸ¢ **å£²ä¸Šç´¯è¨ˆ (ç·‘ç ´ç·š)**: 4æœˆã‹ã‚‰ã®å£²ä¸Šã®ç©ã¿ä¸Šã’ã€‚ç›®æ¨™é”æˆã®é€²æ—ã‚’è¦‹ã¾ã™ã€‚
        * ğŸ”µ **æœˆæ¬¡å£²ä¸Š (é’ç‚¹ç·š)**: æ¯æœˆã®å£²ä¸Šã€‚å­£ç¯€ã«ã‚ˆã£ã¦ã‚¸ã‚°ã‚¶ã‚°ã—ã¾ã™ã€‚

        ### 2. ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰æ
        ã“ã®ç”»é¢ã§ã¯ã€**ã€Œæ–°å¹´åº¦ã®è¨ˆç”»ã€**ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã„ã¾ã™ã€‚

        * ğŸ“ **ç¾åœ¨åœ°**: **2026å¹´4æœˆ**ï¼ˆæ–°å¹´åº¦ãŒå§‹ã¾ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
        * ğŸ“… **è¡¨ç¤ºæœŸé–“**: **2026å¹´4æœˆ ï½ 2027å¹´3æœˆ**ï¼ˆã“ã‚Œã‹ã‚‰ã®1å¹´é–“ï¼‰
        * ğŸ”™ **éå»ãƒ‡ãƒ¼ã‚¿**: ç§»å‹•å¹´è¨ˆï¼ˆèµ¤ç·šï¼‰ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«ã€è£å´ã§ã¯ã€Œ2025å¹´åº¦ï¼ˆå‰æœŸï¼‰ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

        ### 3. è¨­å®šé …ç›®ã¨ã‚°ãƒ©ãƒ•ã®å¤‰åŒ–
        å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§è¨­å®šã‚’å¤‰ãˆã‚‹ã¨ã€ã‚°ãƒ©ãƒ•ã®ä»¥ä¸‹ã®éƒ¨åˆ†ãŒå¤‰åŒ–ã—ã¾ã™ã€‚

        * **â‘  æœŸé¦–(4æœˆ)æ™‚ç‚¹ã®æœˆå•†ãƒ™ãƒ¼ã‚¹ (åƒå††)**:
            * ã‚°ãƒ©ãƒ•å…¨ä½“ã®**é«˜ã•ï¼ˆè¦æ¨¡ï¼‰**ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã®ç›®å®‰ã§ã™ã€‚
        * **â‘¡ æœŸæœ«(3æœˆ)æ™‚ç‚¹ã®ç›®æ¨™æœˆå•† (åƒå††)**:
            * **ğŸ”´ç§»å‹•å¹´è¨ˆï¼ˆèµ¤ç·šï¼‰ã®ã€Œå‚¾ãã€**ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚
            * ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼ˆ4æœˆï¼‰ã¨æ¯”ã¹ã¦ã€ã‚´ãƒ¼ãƒ«ï¼ˆ3æœˆï¼‰ã‚’**é«˜ãè¨­å®šã™ã‚Œã°å³è‚©ä¸ŠãŒã‚Šï¼ˆæˆé•·ï¼‰ã€ä½ãè¨­å®šã™ã‚Œã°å³è‚©ä¸‹ãŒã‚Šï¼ˆè¡°é€€ï¼‰**ã«ãªã‚Šã¾ã™ã€‚ã¾ãšã¯åŒã˜å€¤ã«ã—ã¦æ°´å¹³ãªçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚
        * **å­£ç¯€å¤‰å‹•(ç¹å¿™æœŸè¨­å®š)**:
            * **ğŸ”µæœˆæ¬¡å£²ä¸Šï¼ˆé’ç·šï¼‰ã®ã€Œæ³¢ã®æ¿€ã—ã•ã€**ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚
            * å­£ç¯€æŒ‡æ•°ã‚’ã€Œ1.0ã€ã‹ã‚‰å¤§ããé›¢ã™ã»ã©ã€é’ç·šã®ã‚¸ã‚°ã‚¶ã‚°ãŒå¤§ãããªã‚Šã¾ã™ã€‚
        """)

# --- è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: åˆ†æã‚µãƒ³ãƒ—ãƒ« ---
    with st.expander("ğŸ“ Zãƒãƒ£ãƒ¼ãƒˆã®å…·ä½“çš„ãªèª­ã¿æ–¹ã‚µãƒ³ãƒ—ãƒ«(çµŒå–¶åˆ†æã®ä»•æ–¹)"):
        st.markdown("""
        **ã€ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€‘**
        ç¾åœ¨ã€**2026å¹´4æœˆ**ï¼ˆæ–°å¹´åº¦ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œï¼‰ã§ã™ã€‚
        å‰æœŸï¼ˆ2025å¹´åº¦ï¼‰ã®å®Ÿç¸¾ã‚’è¸ã¾ãˆã€**ä»ŠæœŸï¼ˆ2026å¹´åº¦ï¼‰ã®å£²ä¸Šè¨ˆç”»**ãŒå¦¥å½“ã‹ã©ã†ã‹ã‚’ç¤¾é•·ã¨ç¢ºèªã—ã¦ã„ã‚‹å ´é¢ã§ã™ã€‚

        ### 1. ğŸ”µ æœˆæ¬¡å£²ä¸Šï¼ˆé’ç‚¹ç·šï¼‰ï¼ã€Œãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã¨å­£ç¯€æ€§ã€
        * **ä½•ãŒèª­ã¿å–ã‚Œã‚‹ï¼Ÿ**:
            ãã®ä¼šç¤¾ã®ã€Œãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã€ã‚„ã€Œç¹å¿™æœŸãƒ»é–‘æ•£æœŸã®ã‚µã‚¤ã‚¯ãƒ«ã€ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚
        * **ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ï¼Ÿ**:
            **12æœˆã«5,608åƒå††ï¼ˆå‰æœŸï¼š4,043åƒå††ï¼‰**ã¨ã„ã†çªå‡ºã—ãŸå±±ï¼ˆãƒ”ãƒ¼ã‚¯ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚
            ä¸€æ–¹ã§ã€ä»–ã®æœˆã¯**1,400åƒå††ã€œ2,000åƒå††ï¼ˆå‰æœŸï¼š900åƒå††ã€œ1,300åƒå††å°ï¼‰**å‰å¾Œã§æ¨ç§»ã—ã¦ã„ã¾ã™ã€‚
            å‰æœŸã¨æ¯”ã¹ã¦**å¹³æœˆã§ã‚‚ç´„500åƒå††ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—**ã«æˆåŠŸã—ã¦ãŠã‚Šã€ã•ã‚‰ã«å¹´æœ«å•†æˆ¦ã®æœ€å¤§åŒ–ã‚‚ç‹™ã†è¨ˆç”»ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

        ### 2. ğŸ”´ ç§»å‹•å¹´è¨ˆï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ç·šï¼‰ï¼ã€ŒçœŸã®å®ŸåŠ›ãƒ»æˆé•·ãƒˆãƒ¬ãƒ³ãƒ‰ã€
        * **ä½•ãŒèª­ã¿å–ã‚Œã‚‹ï¼Ÿ**:
            å­£ç¯€å¤‰å‹•ã‚’å–ã‚Šé™¤ã„ãŸã€Œä¼šç¤¾ã®å®ŸåŠ›ã€ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã“ã®ç·šãŒå³è‚©ä¸ŠãŒã‚Šãªã‚‰ã€Œæˆé•·ä¸­ã€ã§ã™ã€‚
        * **ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ï¼Ÿ**:
            ã‚°ãƒ©ãƒ•å·¦ç«¯ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ï¼‰ã®å®ŸåŠ›å€¤ã¯**18,637åƒå††**ã§ã—ãŸãŒã€å³ç«¯ï¼ˆã‚´ãƒ¼ãƒ«æ™‚ï¼‰ã§ã¯**25,628åƒå††**ã¾ã§åˆ°é”ã™ã‚‹è¨ˆç”»ã§ã™ã€‚
            ç¾åœ¨ã®å®ŸåŠ›ï¼ˆç´„18,600åƒå††ï¼‰ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã€1å¹´é–“ã§å®ŸåŠ›ã‚’**ç´„7,000åƒå††**ä¸Šç©ã¿ã™ã‚‹ã€Œå¼·æ°—ã®æˆé•·ãƒˆãƒ¬ãƒ³ãƒ‰ã€ã‚’æã„ã¦ã„ã¾ã™ã€‚

        ### 3. ğŸŸ¢ å£²ä¸Šç´¯è¨ˆï¼ˆç·‘ç ´ç·šï¼‰ï¼ã€Œäº‹æ¥­è¦æ¨¡ã¨ç›®æ¨™é”æˆã€
        * **ä½•ãŒèª­ã¿å–ã‚Œã‚‹ï¼Ÿ**:
            ãã®æœŸã®å£²ä¸Šã®ç©ã¿ä¸ŠãŒã‚Šæ–¹ï¼ˆé€²æ—ï¼‰ã¨ã€æœ€çµ‚çš„ãªã€Œå¹´å•†è¦æ¨¡ã€ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚
        * **ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ï¼Ÿ**:
            12æœˆã®æ€¥è§’åº¦ãªç«‹ã¡ä¸ŠãŒã‚Šã‚’çµŒã¦ã€æœ€çµ‚çš„ã«å³ç«¯ã§ã‚ªãƒ¬ãƒ³ã‚¸ç·šã¨åˆæµã™ã‚‹åœ°ç‚¹ãŒ**25,628åƒå††**ã¨ãªã£ã¦ã„ã¾ã™ã€‚
            å‰æœŸã®å¹´é–“å£²ä¸Šåˆè¨ˆï¼ˆ**18,116åƒå††**ï¼‰ã¨æ¯”è¼ƒã—ã¦ã€**ç´„141%**ã®æˆé•·ã‚’è¦‹è¾¼ã‚€ã€éå¸¸ã«ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãªã€Œå¿…é”ç›®æ¨™ã€ã¨è¨€ãˆã¾ã™ã€‚

        ---
        ### ã€ç¤¾é•·ã¸ã®å ±å‘Šã‚³ãƒ¡ãƒ³ãƒˆä¾‹ã€‘
        > ã€Œç¤¾é•·ã€ä»ŠæœŸã®è¨ˆç”»ã§ã™ãŒã€å‰æœŸã®å®Ÿç¸¾ã‚’å¤§ããä¸Šå›ã‚‹è‰¯ã„å½¢ã§ã™ã€‚
        > ç‰¹å¾´çš„ãªã®ã¯**12æœˆã«æœˆå•†5,608åƒå††ï¼ˆå‰æœŸæ¯”+1,565åƒå††ï¼‰**ã‚’å£²ã‚Šä¸Šã’ã‚‹å¹´æœ«ç‰¹åŒ–å‹ã§ã‚ã‚ŠãªãŒã‚‰ã€å¹³æœˆã§ã‚‚**ç´„1,500åƒå††ä»¥ä¸Šã®ãƒ™ãƒ¼ã‚¹ï¼ˆå‰æœŸæ¯”+500åƒå††å‰å¾Œï¼‰**ã‚’ç¶­æŒã§ãã¦ã„ã‚‹ç‚¹ã§ã™ã€‚
        > é–‘æ•£æœŸã®åº•ä¸Šã’ãŒåŠ¹ã„ã¦ãŠã‚Šã€çµæœã¨ã—ã¦æ¥å¹´3æœˆã«ã¯**å¹´å•†25,628åƒå††ï¼ˆå‰æœŸæ¯”141%ï¼‰**ã®å¤§å°ã‚’çªç ´ã§ãã‚‹ç¢ºå®Ÿãªæˆé•·è»Œé“ã¨è¨€ãˆã¾ã™ï¼ã€
        """)

    # --- è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
    with st.expander("ğŸ”§ Zãƒãƒ£ãƒ¼ãƒˆã£ã¦ã©ã†ã‚„ã£ã¦ä½œã‚‹ã®ï¼Ÿãªãœ2å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã«ãªã‚‹ã®ï¼Ÿ"):
        st.markdown("""
        1å¹´åˆ†ã®Zãƒãƒ£ãƒ¼ãƒˆã‚’ä½œã‚‹ã«ã¯ã€2å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿(â‘ â‘¡)ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
        """)
        
        # --- ã“ã“ã§ã‚³ãƒ³ã‚»ãƒ—ãƒˆå›³ã‚’è¡¨ç¤º ---
        fig_concept = create_concept_diagram()
        st.pyplot(fig_concept)
        # -----------------------------

        st.markdown("""
        ### Zãƒãƒ£ãƒ¼ãƒˆã£ã¦ã©ã†ã‚„ã£ã¦ä½œã‚‹ã®ï¼Ÿ(ã€Œä½œæˆã™ã‚‹ç§»å‹•å¹´è¨ˆã€ã¨ã€Œå…ƒã«ãªã‚‹å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã€ã®é–¢ä¿‚)
        
        ä¸Šå›³ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ç†è§£ã§ãã‚‹ã‚ˆã†ã«æœ€åˆã®2ãƒ¶æœˆã¨æœ€å¾Œã®2ãƒ¶æœˆã®ã€Œä½œæˆã™ã‚‹ç§»å‹•å¹´è¨ˆã€ã¨ã€Œå…ƒã«ãªã‚‹å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã€ã®é–¢ä¿‚ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚**1å¹´åˆ†ã®ã€Œå…ƒã«ãªã‚‹å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã€ã‚’12ãƒ¶æœˆã§å‰²ã‚‹ã“ã¨ã§ã€1ãƒ¶æœˆåˆ†ã®ã€Œä½œæˆã™ã‚‹ç§»å‹•å¹´è¨ˆã€ãŒä½œæˆã§ãã¾ã™ã€‚**

        Zãƒãƒ£ãƒ¼ãƒˆã®ç§»å‹•å¹´è¨ˆã¯ã€**ã€Œãã®æœˆï¼ˆå½“æœˆï¼‰ã‚’å«ã‚€éå»1å¹´é–“ã€**ã®åˆè¨ˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
        å›³ã®ç‚¹ç·šçŸ¢å°ãŒç¤ºã™ã‚ˆã†ã«ã€12ãƒ¶æœˆåˆ†ã®æœŸé–“ï¼ˆãƒãƒ¼ã®ç¯„å›²ï¼‰ã‚’é›†è¨ˆã—ãŸçµæœãŒã€ãã®æœˆã®ç§»å‹•å¹´è¨ˆï¼ˆâ—å°ï¼‰ã«ãªã‚Šã¾ã™ã€‚
        
        - 2026å¹´4æœˆåˆ†ã®ç§»å‹•å¹´è¨ˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã¯**2025å¹´5æœˆã‹ã‚‰2026å¹´4æœˆã¾ã§**ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
        - 2026å¹´5æœˆåˆ†ã®ç§»å‹•å¹´è¨ˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã¯**2025å¹´6æœˆã‹ã‚‰2026å¹´5æœˆã¾ã§**ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
        - 2027å¹´2æœˆåˆ†ã®ç§»å‹•å¹´è¨ˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã¯**2026å¹´3æœˆã‹ã‚‰2027å¹´2æœˆã¾ã§**ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
        - 2027å¹´3æœˆåˆ†ã®ç§»å‹•å¹´è¨ˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã¯**2026å¹´4æœˆã‹ã‚‰2027å¹´3æœˆã¾ã§**ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

        ### ãªãœ2å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã«ãªã‚‹ã®ï¼Ÿ
        **â‘  ã¾ãšã¯ã€ç§»å‹•å¹´è¨ˆã‚’1å¹´åˆ†(12å›)ä½œã‚‹ãŸã‚ã«ã€å®Ÿéš›ã®å®Ÿç¸¾éå»ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦éå»1å¹´åˆ†ã®å£²ä¸Šé«˜ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã™ã€‚**
        ä»Šå›ã¯ã€ç°¡æ˜“çš„ã«ã“ã‚Œã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã®ã€Œâ‘ æœŸé¦–(4æœˆ)æ™‚ç‚¹ã®æœˆå•†ãƒ™ãƒ¼ã‚¹ï¼ˆåƒå††ï¼‰ã€ã¨ã€Œå­£ç¯€å¤‰å‹•(ç¹å¿™æœŸè¨­å®š)ã€ã®æ•°å€¤ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

        **â‘¡ æ¬¡ã«ã€ç¾åœ¨åœ°(2026å¹´4æœˆ)ã‹ã‚‰ã®1å¹´åˆ†ã¯ã€ç›®æ¨™æœˆå•†(äºˆæƒ³ãƒ»äºˆæ¸¬)ã¨ã—ã¦å£²ä¸Šé«˜ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã™ã€‚**
        ä»Šå›ã¯ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã®ã€Œâ‘¡æœŸæœ«(3æœˆ)æ™‚ç‚¹ã®ç›®æ¨™æœˆå•†(åƒå††)ã€ã¨ã€Œå­£ç¯€å¤‰å‹•(ç¹å¿™æœŸè¨­å®š)ã€ã®æ•°å€¤ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
        """)

    # --- ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š ---
    st.sidebar.header("âš™ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š")
    
    # 1. åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    st.sidebar.subheader("1. åŸºç¤æ•°å€¤ (è¨ˆç”»ã®å‰æ)")
    
    # (1) ãƒ™ãƒ¼ã‚¹å£²ä¸Š (æœŸé¦–ã®æœˆå•†)
    input_base_sales = st.sidebar.slider(
        "â‘  æœŸé¦–(4æœˆ)æ™‚ç‚¹ã®æœˆå•†ãƒ™ãƒ¼ã‚¹ (åƒå††)",
        min_value=500, max_value=2000, value=1000, step=100,
        help="ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã¨ãªã‚‹ã€ä»Šç¾åœ¨ã®å¹³å‡æœˆå•†ã§ã™ã€‚"
    )

    # (2) æˆé•·è¦‹è¾¼ã¿ -> ã€ŒæœŸæœ«ã®ç›®æ¨™ã€ã«å¤‰æ›´
    #      ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã€Œãƒ™ãƒ¼ã‚¹å£²ä¸Š+500ã€ã«ã™ã‚‹ãŸã‚ã€valueã®åˆæœŸå€¤ã‚’å‹•çš„ã«è¨­å®š
    input_target_sales = st.sidebar.slider(
        "â‘¡ æœŸæœ«(3æœˆ)æ™‚ç‚¹ã®ç›®æ¨™æœˆå•† (åƒå††)",
        min_value=0, # 0ãªã‚‰å®Œå…¨æ’¤é€€
        max_value=input_base_sales * 3, 
        value=input_base_sales + 500, # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æˆé•·ã—ãŸçŠ¶æ…‹ã«ã—ã¦ãŠã
        step=50,
        help="1å¹´å¾Œã«ã€æœˆå•†ãƒ™ãƒ¼ã‚¹ã‚’ã©ã“ã¾ã§æŒã£ã¦ã„ããŸã„ã‹ï¼ˆç›®æ¨™ï¼‰ã‚’è¨­å®šã—ã¾ã™ã€‚"
    )

    # --- å†…éƒ¨è¨ˆç®—: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰ã€Œæˆé•·é¡ã€ã‚’é€†ç®—ã™ã‚‹ ---
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã¯ã€Œç›®æ¨™ã€ã‚’å…¥åŠ›ã—ã¦ã„ã‚‹ãŒã€
    # ãƒ­ã‚¸ãƒƒã‚¯ä¸Šã¯ã€Œå·®é¡(input_growth)ã€ã¨ã—ã¦æ¸¡ã™ã“ã¨ã§ã€å…ƒã®generate_dataé–¢æ•°ã‚’ãã®ã¾ã¾ä½¿ãˆã‚‹
    input_growth = input_target_sales - input_base_sales

    # --- è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (èª¤è§£é˜²æ­¢ã®ãŸã‚ã®è¡¨ç¤º) ---
    if input_growth > 0:
        growth_msg = f"ğŸ“ˆ å³è‚©ä¸ŠãŒã‚Š (æœˆå•† +{input_growth:,}åƒå†† ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—)"
        msg_color = "green"
    elif input_growth == 0:
        growth_msg = "â¡ï¸ ç¾çŠ¶ç¶­æŒ (æ¨ªã°ã„)"
        msg_color = "gray"
    else:
        growth_msg = f"ğŸ“‰ å³è‚©ä¸‹ãŒã‚Š (æœˆå•† {input_growth:,}åƒå†† ã®ç¸®å°)"
        msg_color = "red"

    st.sidebar.markdown(f"""
    <div style="background-color: #f0f2f6; padding: 10px; border-radius: 5px; font-size: 0.9em;">
        <b>è¨­å®šã•ã‚ŒãŸãƒˆãƒ¬ãƒ³ãƒ‰:</b><br>
        <span style="color: {msg_color}; font-weight: bold;">{growth_msg}</span><br>
        <br>
        ğŸ <b>æœŸé¦–(4æœˆ):</b> {input_base_sales:,} åƒå††<br>
        â¬‡ï¸ (1å¹´ã‹ã‘ã¦å¤‰åŒ–)<br>
        ğŸ <b>æœŸæœ«(3æœˆ):</b> {input_target_sales:,} åƒå††
    </div>
    """, unsafe_allow_html=True)

    with st.sidebar.expander("â“ ã“ã®è¨­å®šã®æ„å‘³ã¯ï¼Ÿ"):
        st.markdown("""
        **ã€Œ1å¹´é–“ã‹ã‘ã¦ã€ä¼šç¤¾ã®åŸºç¤ä½“åŠ›ï¼ˆæœˆå•†ãƒ™ãƒ¼ã‚¹ï¼‰ã‚’ã©ã“ã¾ã§å¼•ãä¸Šã’ãŸã„ã‹ã€**ã‚’è¨­å®šã—ã¾ã™ã€‚
        
        * å­£ç¯€ã”ã¨ã®æ³¢ï¼ˆç¹å¿™æœŸãªã©ï¼‰ã¯ã€ã“ã®é‡‘é¡ã«ã•ã‚‰ã«æ›ã‘ç®—ã•ã‚Œã¾ã™ã€‚
        * ã“ã“ã§ã¯**ã€Œå­£ç¯€è¦å› ã‚’é™¤ã„ãŸå®ŸåŠ›å€¤ã€**ã®ç›®æ¨™ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
        
        ä¾‹ãˆã°ã€**æœŸé¦–1,000** â†’ **æœŸæœ«1,500** ã¨è¨­å®šã™ã‚‹ã¨ã€1å¹´é–“ã‹ã‘ã¦åŸºç¤æœˆå•†ãŒ500åƒå††ã‚¢ãƒƒãƒ—ã™ã‚‹ã€Œå³è‚©ä¸ŠãŒã‚Šã€ã®è¨ˆç”»ã«ãªã‚Šã¾ã™ã€‚
        """)
    
    st.sidebar.markdown("---")

    # 2. å­£ç¯€æŒ‡æ•°ã®è¨­å®š
    st.sidebar.subheader("2. å­£ç¯€å¤‰å‹• (ç¹å¿™æœŸè¨­å®š)")
    with st.sidebar.expander("ğŸ“… å­£ç¯€æŒ‡æ•°ã‚’è©³ã—ãè¨­å®šã™ã‚‹", expanded=False):
        st.markdown("""
        <small>
        æœˆã”ã¨ã®å£²ä¸Šã®æ³¢ã‚’è¨­å®šã§ãã¾ã™ã€‚<br>
        ãƒ»<b>1.0</b> ï¼š å¹³å‡çš„ãªæœˆ<br>
        ãƒ»<b>1.2</b> ï¼š 2å‰²å¢— (ç¹å¿™æœŸ)<br>
        ãƒ»<b>0.8</b> ï¼š 2å‰²æ¸› (é–‘æ•£æœŸ)<br>
        ç›´æ¥æ•°å€¤ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚
        </small>
        """, unsafe_allow_html=True)

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å­£ç¯€æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿ï¼ˆ4æœˆå§‹ã¾ã‚Šï¼‰
        default_months = [f"{i}æœˆ" for i in [4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3]]
        default_indices = [1.0, 0.9, 1.1, 1.2, 1.0, 0.9, 1.0, 1.1, 3.0, 0.8, 0.9, 1.5]

        # ç·¨é›†ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
        seasonality_df = pd.DataFrame({
            "æœˆ": default_months,
            "å­£ç¯€æŒ‡æ•°": default_indices
        })

        # ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ã®è¡¨ç¤º
        edited_df = st.data_editor(
            seasonality_df,
            column_config={
                "æœˆ": st.column_config.TextColumn("æœˆ", disabled=True),
                "å­£ç¯€æŒ‡æ•°": st.column_config.NumberColumn("æŒ‡æ•°", min_value=0.0, max_value=5.0, step=0.1, format="%.1f")
            },
            hide_index=True,
            use_container_width=True,
            num_rows="fixed"
        )
        seasonality_pattern = edited_df["å­£ç¯€æŒ‡æ•°"].tolist()

    st.sidebar.info("å€¤ã‚’å¤‰æ›´ã™ã‚‹ã¨ã‚°ãƒ©ãƒ•ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚")

    # --- ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã¨è¨ˆç®— ---
    df = generate_data(input_base_sales, input_growth, seasonality_pattern)
    fig_plotly, chart_df = create_plotly_z_chart(df)

    # --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢: Plotlyè¡¨ç¤º ---
    st.subheader("ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–åˆ†æ (Plotly)")
    st.plotly_chart(fig_plotly, use_container_width=True)

    # --- è©³ç´°ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º ---
    with st.expander("è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹"):
        st.dataframe(chart_df[['å¹´æœˆ', 'å£²ä¸Šé«˜', 'å£²ä¸Šç´¯è¨ˆ', 'ç§»å‹•å¹´è¨ˆ']].style.format({
            'å£²ä¸Šé«˜': '{:,} åƒå††',
            'å£²ä¸Šç´¯è¨ˆ': '{:,} åƒå††',
            'ç§»å‹•å¹´è¨ˆ': '{:,} åƒå††'
        }))
        
        csv = chart_df.to_csv(index=False).encode('utf-8-sig')
        st.download_button(
            label="ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
            data=csv,
            file_name='z_chart_analysis.csv',
            mime='text/csv',
        )

    # --- Matplotlibè¡¨ç¤º ---
    st.markdown("---")
    st.subheader("å£²ä¸Šé«˜Zãƒãƒ£ãƒ¼ãƒˆåˆ†æ(Matplotlibä½¿ç”¨ - å…¨æ•°å€¤è¡¨ç¤º)")
    st.markdown("â€»å°åˆ·ã‚„ãƒ¬ãƒãƒ¼ãƒˆè²¼ã‚Šä»˜ã‘ç”¨ã®é™æ­¢ç”»ã§ã™ã€‚å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã«é‡‘é¡ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚")
    
    # Matplotlibã®å›³ã‚’ä½œæˆã—ã¦è¡¨ç¤º
    fig_mpl = create_matplotlib_z_chart(chart_df)
    st.pyplot(fig_mpl)

    # =======================================================
    # æ–°æ©Ÿèƒ½: å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿è¡¨ (24ãƒ¶æœˆåˆ†)
    # =======================================================
    st.markdown("---")
    st.subheader("ã€è¡¨ã€‘å¹´æœˆãƒ»æœˆæ¬¡å£²ä¸Šãƒ»å£²ä¸Šç´¯è¨ˆ(YTD)ãƒ»ç§»å‹•å¹´è¨ˆ(MAT)")
    st.markdown("â€»ã€Œå£²ä¸Šç´¯è¨ˆ(YTD)ã€ã¨ã€Œç§»å‹•å¹´è¨ˆ(MAT)ã€ã¯ã€å½“æœŸã®12ãƒ¶æœˆåˆ†ã®ã¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚")

    # 24è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®æº–å‚™
    full_table_df = df.copy()

    # æ–‡å­—åˆ—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”¨ã®ãƒªã‚¹ãƒˆã‚’æº–å‚™
    table_rows = []

    for i in range(len(full_table_df)):
        # 1. åŸºæœ¬ãƒ‡ãƒ¼ã‚¿å–å¾—
        row_date = full_table_df.iloc[i]['å¹´æœˆ']
        row_sales = full_table_df.iloc[i]['å£²ä¸Šé«˜']
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: å¹´æœˆã¨å£²ä¸Šé«˜
        date_str = row_date.strftime('%Yå¹´%mæœˆ')
        sales_str = f"{int(row_sales):,}"

        # 2. YTDã¨MATã®åˆ¶å¾¡ (å½“æœŸåˆ†=å¾ŒåŠ12è¡Œã®ã¿è¡¨ç¤º)
        # dfã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯0ã€œ23ã€‚å½“æœŸã¯12ã€œ23ã€‚
        if i >= 12:
            # --- å£²ä¸Šç´¯è¨ˆ (YTD) ---
            # chart_dfã¯å½“æœŸ12ãƒ¶æœˆåˆ†ã®ã¿ã®DFãªã®ã§ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆã‚ã›ã‚‹
            # i=12ã®ã¨ãã€chart_dfã®0è¡Œç›®ã‚’å‚ç…§
            ytd_val = chart_df.iloc[i - 12]['å£²ä¸Šç´¯è¨ˆ']
            ytd_str = f"{int(ytd_val):,}"
            
            # --- ç§»å‹•å¹´è¨ˆ (MAT) ---
            # dfã«ã¯æ—¢ã«è¨ˆç®—æ¸ˆã¿ã® 'ç§»å‹•å¹´è¨ˆ' åˆ—ãŒã‚ã‚‹
            mat_val = full_table_df.iloc[i]['ç§»å‹•å¹´è¨ˆ']
            mat_str = f"{int(mat_val):,}"
        else:
            # å‰æœŸåˆ†ã¯ç©ºç™½è¡¨ç¤º
            ytd_str = "-"
            mat_str = "-"

        # è¡Œãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        table_rows.append([date_str, sales_str, ytd_str, mat_str])

    # è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
    display_df = pd.DataFrame(table_rows, columns=['å¹´æœˆ', 'æœˆæ¬¡å£²ä¸Š', 'å£²ä¸Šç´¯è¨ˆ(YTD)', 'ç§»å‹•å¹´è¨ˆ(MAT)'])

    # ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    st.table(display_df)

if __name__ == "__main__":
    main()